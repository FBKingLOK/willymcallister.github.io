---
layout: article
title:  "Staticman and Mailgun"
author: Willy McAllister
comments: true
---

Spinningnumbers.org is a static web site. I use [Staticman v2](https://staticman.net) as a service to make it seem like my static site is responsive to learner comments and discussion.

Staticman supports allowing users to enter their email address with me, to subscribe to a post and be notified if new comments appear. Here's how I did that.


----

### Contents
{:.no_toc}

* Will be replaced with the ToC
{:toc}

----

## Resources

Staticman - http://staticman.org. I don't run my own server, Iuse the public instantiation of Staticman. 
Staticman on github - https://github.com/eduardoboucas/staticman. Watch this repository to follow along with Staticman's development and issues.   

Eduardo's personal site on github - https://github.com/eduardoboucas/eduardoboucas.github.io  

Michael Rose's personal site - https://mademistakes.com/articles/improving-jekyll-static-comments/ - Tutorial on upgrading to Staticman v2 and nested comments. Michael's site uses jekyll and has nested comments with mail replies, but is not generated by GitHub Pages. 

Michael's personal site source on github - https://github.com/mmistakes/made-mistakes-jekyll. This was my primary inspiration for implementing Staticman, comments, and mail for spinninnumbers.org.

MailGun - https://www.mailgun.com/, an ESP (email service provider) known to Staticman. I set up my own account. 

GitHub Pages - https://pages.github.com/

Popcorn - http://popcorn.staticman.net/. Staticman's demo site (uses Staticman v1)  
Popcorn on github - https://github.com/eduardoboucas/popcorn  

## Encryption

Staticman encrypts some stuff. 
Mailgun encrypts other stuff. 
Don't double-encrypt.  

## About spinninnumbers.org

I bought the domain name. It is hosted at ehost.com.

This site is in a repository at [GitHub](https://github.com/willymcallister/spinningnumbers) and is hosted by [GitHub Pages](https://pages.github.com/). When GitHub Pages detects a changed file in the repository, it triggers [Jekyll](https://jekyllrb.com/) to rebuild the site. I'm using the default '[minima](https://github.com/jekyll/minima)' theme with a few additions to the stylesheet, assets/main.scss. 

The articles are written in Jekyll's [Kramdown](https://kramdown.gettalong.org/documentation.html) superset of markdown. 

Equations are rendered by [$\KaTeX$](https://khan.github.io/KaTeX/), the super-fast math typesetting library from Khan Academy. The KaTeX equation renderer runs after the page loads. See the line in _layouts/default.html where it calls {% include katex.html  %}

Animated .svg images are created with [D3.js](http://d3js.org). The source code for the animations is on [github](https://github.com/willymcallister/spinningnumbers/tree/master/assets/d3). Wherever possible, I use the .svg graphic format for images, due to its flexibility in handling different screens. The lion's share of images on the site were created in Adobe Illustrator. My graphic tool of choice now is [Inkscape](https://inkscape.org/).

This is a static site. Comments are implemented with [Staticman](https://staticman.net/), with protection from robots provided by [reCAPTCHA](https://www.google.com/recaptcha/intro/). 

## Overview: how Staticman creates comments and uses MailGun

My site has a comment form (\_includes/comment form.html). When the user fills out the form and clicks Submit, the form is sent over the web to Staticman. Staticman receives the comment info and submits it to GitHub as a Pull Request (PR) for the spinninnumbers.org respository. I have it set up to immediately accept the PR (in staticman.yml: moderation: false). The PR puts the comment and author info into spinningnumbers/\_data/comments/* folder. This file change triggers GitHub Pages to regenerate the changed parts of the spinninnumbers web files. When the use refreshes her browser page, the comment appears. 

At the same time Staticman is sending the PR to GitHub, it sends a request to my MailGun account to add the comment author's email address to a mailing list for this particular article. If the mailinglist does't exist, Staticman asks for one to be created. The mailinglist will have an encoded name, like affa4704f06fda2245c5ed9d54932d35@mg.spinningnumbers.org. The addition of new comment triggers an email sent to the entire mailing list, so everybody who has subscribed gets to see it.


## Setting up MailGun

Sign up for an account at MailGun. The signup page is https://app.mailgun.com/new/signup/. 

The account is free until you exceed 10,000 emails per month. Even though it is free, you should still enter a credit card number and get yourself on the Unity Plan. MailGun won't charge it if you stay under 10K emails. Entering a credit card number enables some features you want, like the ability to send an email to an address that is has not been entered into your Authorized Recipients list (limit 5). 

Tell MailGun about your domain:   
Click on Add your domain. Enter your personal domain name with ".mg" on the front. 

Tell your ISP about MailGun:  
You have to add some lines to your domain records where your domain is hosted. 


Your MailGun API keys:
You will be issued two API keys, one secret, one public. They are listed in several places in your online account pages. The secret key starts with "key-". The public key starts with "pubkey-". 
